<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Lwt_pipe (lwt-pipe.Lwt_pipe)</title><link rel="stylesheet" href="../../odoc.css"/><meta charset="utf-8"/><meta name="generator" content="odoc 2.1.0"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body class="odoc"><nav class="odoc-nav"><a href="../index.html">Up</a> â€“ <a href="../index.html">lwt-pipe</a> &#x00BB; Lwt_pipe</nav><header class="odoc-preamble"><h1>Module <code><span>Lwt_pipe</span></code></h1></header><nav class="odoc-toc"><ul><li><a href="#pipes,-readers,-writers">Pipes, Readers, Writers</a><ul><li><a href="#write-only-interface-and-combinators">Write-only Interface and Combinators</a></li><li><a href="#read-only-interface-and-combinators">Read-only Interface and Combinators</a></li><li><a href="#conversions">Conversions</a></li><li><a href="#basic-io-wrappers">Basic IO wrappers</a></li></ul></li></ul></nav><div class="odoc-content"><h2 id="pipes,-readers,-writers"><a href="#pipes,-readers,-writers" class="anchor"></a>Pipes, Readers, Writers</h2><p>Stream processing using:</p><ul><li>Pipe: a possibly buffered channel that can act as a reader or as a writer</li><li>Reader: accepts values, produces effects</li><li>Writer: yield values</li></ul><p>Examples:</p><pre><code>#require &quot;lwt&quot;;;

module P = Lwt_pipe;;

let p1 =
  P.of_list CCList.(1 -- 100)
  |&gt; P.Reader.map ~f:string_of_int;;

Lwt_io.with_file ~mode:Lwt_io.output &quot;/tmp/foo&quot;
  (fun oc -&gt;
     let p2 = P.IO.write_lines oc in
     P.connect ~ownership:`InOwnsOut p1 p2;
     P.wait p2
  );;</code></pre><p><b>status: experimental</b></p><div class="odoc-spec"><div class="spec exception" id="exception-Closed" class="anchored"><a href="#exception-Closed" class="anchor"></a><code><span><span class="keyword">exception</span> </span><span><span class="exception">Closed</span></span></code></div></div><div class="odoc-spec"><div class="spec type" id="type-t" class="anchored"><a href="#type-t" class="anchor"></a><code><span><span class="keyword">type</span> <span>('a, +'perm) t</span></span><span> <span class="keyword">constraint</span> <span class="type-var">'perm</span> = <span>[&lt; `r <span>| `w</span> ]</span></span></code></div><div class="spec-doc"><p>A pipe between producers of values of type 'a, and consumers of values of type 'a.</p></div></div><div class="odoc-spec"><div class="spec type" id="type-pipe" class="anchored"><a href="#type-pipe" class="anchor"></a><code><span><span class="keyword">type</span> <span>('a, 'perm) pipe</span></span><span> = <span><span>( <span class="type-var">'a</span>, <span class="type-var">'perm</span> )</span> <a href="#type-t">t</a></span></span></code></div></div><div class="odoc-spec"><div class="spec type" id="type-read_timeout_result" class="anchored"><a href="#type-read_timeout_result" class="anchor"></a><code><span><span class="keyword">type</span> <span>'a read_timeout_result</span></span><span> = </span></code><table><tr id="type-read_timeout_result.Pipe_closed" class="anchored"><td class="def variant constructor"><a href="#type-read_timeout_result.Pipe_closed" class="anchor"></a><code><span>| </span><span><span class="constructor">Pipe_closed</span></span></code></td></tr><tr id="type-read_timeout_result.Nothing_available" class="anchored"><td class="def variant constructor"><a href="#type-read_timeout_result.Nothing_available" class="anchor"></a><code><span>| </span><span><span class="constructor">Nothing_available</span></span></code></td></tr><tr id="type-read_timeout_result.Timeout" class="anchored"><td class="def variant constructor"><a href="#type-read_timeout_result.Timeout" class="anchor"></a><code><span>| </span><span><span class="constructor">Timeout</span></span></code></td></tr><tr id="type-read_timeout_result.Data_available" class="anchored"><td class="def variant constructor"><a href="#type-read_timeout_result.Data_available" class="anchor"></a><code><span>| </span><span><span class="constructor">Data_available</span> <span class="keyword">of</span> <span class="type-var">'a</span></span></code></td><td class="def-doc"><span class="comment-delim">(*</span><p>Return type for the <code>read_with_timeout</code> function</p><span class="comment-delim">*)</span></td></tr></table></div></div><div class="odoc-spec"><div class="spec value" id="val-keep" class="anchored"><a href="#val-keep" class="anchor"></a><code><span><span class="keyword">val</span> keep : <span><span><span>( <span class="type-var">_</span>, <span class="type-var">_</span> )</span> <a href="#type-t">t</a></span> <span class="arrow">&#45;&gt;</span></span> <span><span>unit <span class="xref-unresolved">Lwt</span>.t</span> <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p><code>keep p fut</code> adds a pointer from <code>p</code> to <code>fut</code> so that <code>fut</code> is not garbage-collected before <code>p</code></p></div></div><div class="odoc-spec"><div class="spec value" id="val-is_closed" class="anchored"><a href="#val-is_closed" class="anchor"></a><code><span><span class="keyword">val</span> is_closed : <span><span><span>( <span class="type-var">_</span>, <span class="type-var">_</span> )</span> <a href="#type-t">t</a></span> <span class="arrow">&#45;&gt;</span></span> bool</span></code></div></div><div class="odoc-spec"><div class="spec value" id="val-close" class="anchored"><a href="#val-close" class="anchor"></a><code><span><span class="keyword">val</span> close : <span><span><span>( <span class="type-var">_</span>, <span class="type-var">_</span> )</span> <a href="#type-t">t</a></span> <span class="arrow">&#45;&gt;</span></span> <span>unit <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>close p</code> closes <code>p</code>, which will not accept input anymore. This sends <code>End</code> to all readers connected to <code>p</code></p></div></div><div class="odoc-spec"><div class="spec value" id="val-close_nonblock" class="anchored"><a href="#val-close_nonblock" class="anchor"></a><code><span><span class="keyword">val</span> close_nonblock : <span><span><span>( <span class="type-var">_</span>, <span class="type-var">_</span> )</span> <a href="#type-t">t</a></span> <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p>Same as <a href="#val-close"><code>close</code></a> but does not wait for completion of dependent tasks</p></div></div><div class="odoc-spec"><div class="spec value" id="val-wait" class="anchored"><a href="#val-wait" class="anchor"></a><code><span><span class="keyword">val</span> wait : <span><span><span>( <span class="type-var">_</span>, <span class="type-var">_</span> )</span> <a href="#type-t">t</a></span> <span class="arrow">&#45;&gt;</span></span> <span>unit <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p>Evaluates once the pipe closes</p></div></div><div class="odoc-spec"><div class="spec value" id="val-create" class="anchored"><a href="#val-create" class="anchor"></a><code><span><span class="keyword">val</span> create : 
  <span>?on_close:<span>( <span>unit <span class="arrow">&#45;&gt;</span></span> unit )</span> <span class="arrow">&#45;&gt;</span></span>
  <span>?max_size:int <span class="arrow">&#45;&gt;</span></span>
  <span>unit <span class="arrow">&#45;&gt;</span></span>
  <span><span>( <span class="type-var">'a</span>, <span class="type-var">'perm</span> )</span> <a href="#type-t">t</a></span></span></code></div><div class="spec-doc"><p>Create a new pipe.</p><ul class="at-tags"><li class="parameter"><span class="at-tag">parameter</span> <span class="value">on_close</span> <p>called when the pipe is closed</p></li></ul><ul class="at-tags"><li class="parameter"><span class="at-tag">parameter</span> <span class="value">max_size</span> <p>size of internal buffer. Default 0.</p></li></ul></div></div><div class="odoc-spec"><div class="spec value" id="val-connect" class="anchored"><a href="#val-connect" class="anchor"></a><code><span><span class="keyword">val</span> connect : 
  <span>?ownership:<span>[ `None <span>| `InOwnsOut</span> <span>| `OutOwnsIn</span> ]</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span>( <span class="type-var">'a</span>, <span>[&gt; `r ]</span> )</span> <a href="#type-t">t</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span>( <span class="type-var">'a</span>, <span>[&gt; `w ]</span> )</span> <a href="#type-t">t</a></span> <span class="arrow">&#45;&gt;</span></span>
  unit</span></code></div><div class="spec-doc"><p><code>connect p1 p2</code> forwards every item output by <code>p1</code> into <code>p2</code>'s input until <code>p1</code> is closed.</p><ul class="at-tags"><li class="parameter"><span class="at-tag">parameter</span> <span class="value">own</span> <p>determines which pipes owns which (the owner, when it closes, also closes the ownee)</p></li></ul></div></div><div class="odoc-spec"><div class="spec value" id="val-link_close" class="anchored"><a href="#val-link_close" class="anchor"></a><code><span><span class="keyword">val</span> link_close : <span><span><span>( <span class="type-var">_</span>, <span class="type-var">_</span> )</span> <a href="#type-t">t</a></span> <span class="arrow">&#45;&gt;</span></span> <span>after:<span><span>( <span class="type-var">_</span>, <span class="type-var">_</span> )</span> <a href="#type-t">t</a></span> <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p><code>link_close p ~after</code> will close <code>p</code> when <code>after</code> closes. if <code>after</code> is closed already, closes <code>p</code> immediately</p></div></div><div class="odoc-spec"><div class="spec value" id="val-read" class="anchored"><a href="#val-read" class="anchor"></a><code><span><span class="keyword">val</span> read : <span><span><span>( <span class="type-var">'a</span>, <span>[&gt; `r ]</span> )</span> <a href="#type-t">t</a></span> <span class="arrow">&#45;&gt;</span></span> <span><span><span class="type-var">'a</span> option</span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p>Read the next value from a Pipe</p></div></div><div class="odoc-spec"><div class="spec value" id="val-read_with_timeout" class="anchored"><a href="#val-read_with_timeout" class="anchor"></a><code><span><span class="keyword">val</span> read_with_timeout : 
  <span><span><span>( <span class="type-var">'a</span>, <span>[&gt; `r ]</span> )</span> <a href="#type-t">t</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span>timeout:<span>float option</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span class="type-var">'a</span> <a href="#type-read_timeout_result">read_timeout_result</a></span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>read_with_timeout p ~timeout</code> read the next value from a Pipe, optionally waiting for at most a number of seconds passed with the <code>timeout</code> parameter.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-write" class="anchored"><a href="#val-write" class="anchor"></a><code><span><span class="keyword">val</span> write : <span><span><span>( <span class="type-var">'a</span>, <span>[&gt; `w ]</span> )</span> <a href="#type-t">t</a></span> <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'a</span> <span class="arrow">&#45;&gt;</span></span> <span>bool <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p>Returns <code>false</code> if the pipe is closed</p></div></div><div class="odoc-spec"><div class="spec value" id="val-write_exn" class="anchored"><a href="#val-write_exn" class="anchor"></a><code><span><span class="keyword">val</span> write_exn : <span><span><span>( <span class="type-var">'a</span>, <span>[&gt; `w ]</span> )</span> <a href="#type-t">t</a></span> <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'a</span> <span class="arrow">&#45;&gt;</span></span> <span>unit <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><ul class="at-tags"><li class="raises"><span class="at-tag">raises</span> <span class="value">Closed</span> <p>if the writer is closed</p></li></ul></div></div><div class="odoc-spec"><div class="spec value" id="val-write_list" class="anchored"><a href="#val-write_list" class="anchor"></a><code><span><span class="keyword">val</span> write_list : <span><span><span>( <span class="type-var">'a</span>, <span>[&gt; `w ]</span> )</span> <a href="#type-t">t</a></span> <span class="arrow">&#45;&gt;</span></span> <span><span><span class="type-var">'a</span> list</span> <span class="arrow">&#45;&gt;</span></span> <span>bool <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p>Returns <code>false</code> if the pipe is closed</p></div></div><div class="odoc-spec"><div class="spec value" id="val-write_list_exn" class="anchored"><a href="#val-write_list_exn" class="anchor"></a><code><span><span class="keyword">val</span> write_list_exn : <span><span><span>( <span class="type-var">'a</span>, <span>[&gt; `w ]</span> )</span> <a href="#type-t">t</a></span> <span class="arrow">&#45;&gt;</span></span> <span><span><span class="type-var">'a</span> list</span> <span class="arrow">&#45;&gt;</span></span> <span>unit <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><ul class="at-tags"><li class="raises"><span class="at-tag">raises</span> <span class="value">Closed</span> <p>if the writer is closed</p></li></ul></div></div><div class="odoc-spec"><div class="spec value" id="val-to_stream" class="anchored"><a href="#val-to_stream" class="anchor"></a><code><span><span class="keyword">val</span> to_stream : <span><span><span>( <span class="type-var">'a</span>, <span>[&gt; `r ]</span> )</span> <a href="#type-t">t</a></span> <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'a</span> <span class="xref-unresolved">Lwt_stream</span>.t</span></span></code></div><div class="spec-doc"><p><code>to_stream p</code> returns a stream with the content from <code>p</code>. The stream will close when <code>p</code> closes.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-of_stream" class="anchored"><a href="#val-of_stream" class="anchor"></a><code><span><span class="keyword">val</span> of_stream : <span><span><span class="type-var">'a</span> <span class="xref-unresolved">Lwt_stream</span>.t</span> <span class="arrow">&#45;&gt;</span></span> <span><span>( <span class="type-var">'a</span>, <span>[&gt; `r ]</span> )</span> <a href="#type-t">t</a></span></span></code></div><div class="spec-doc"><p><code>of_stream s</code> reads from <code>s</code>. The returned pipe will close when <code>s</code> closes.</p></div></div><h3 id="write-only-interface-and-combinators"><a href="#write-only-interface-and-combinators" class="anchor"></a>Write-only Interface and Combinators</h3><div class="odoc-spec"><div class="spec module" id="module-Writer" class="anchored"><a href="#module-Writer" class="anchor"></a><code><span><span class="keyword">module</span> <a href="Writer/index.html">Writer</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div></div><h3 id="read-only-interface-and-combinators"><a href="#read-only-interface-and-combinators" class="anchor"></a>Read-only Interface and Combinators</h3><div class="odoc-spec"><div class="spec module" id="module-Reader" class="anchored"><a href="#module-Reader" class="anchor"></a><code><span><span class="keyword">module</span> <a href="Reader/index.html">Reader</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div></div><h3 id="conversions"><a href="#conversions" class="anchor"></a>Conversions</h3><div class="odoc-spec"><div class="spec type" id="type-lwt_klist" class="anchored"><a href="#type-lwt_klist" class="anchor"></a><code><span><span class="keyword">type</span> <span>'a lwt_klist</span></span><span> = <span><span>[ `Nil <span><span>| `Cons</span> of <span class="type-var">'a</span> * <span><span class="type-var">'a</span> <a href="#type-lwt_klist">lwt_klist</a></span></span> ]</span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div></div><div class="odoc-spec"><div class="spec value" id="val-of_list" class="anchored"><a href="#val-of_list" class="anchor"></a><code><span><span class="keyword">val</span> of_list : <span><span><span class="type-var">'a</span> list</span> <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'a</span> <a href="Reader/index.html#type-t">Reader.t</a></span></span></code></div></div><div class="odoc-spec"><div class="spec value" id="val-of_array" class="anchored"><a href="#val-of_array" class="anchor"></a><code><span><span class="keyword">val</span> of_array : <span><span><span class="type-var">'a</span> array</span> <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'a</span> <a href="Reader/index.html#type-t">Reader.t</a></span></span></code></div></div><div class="odoc-spec"><div class="spec value" id="val-of_string" class="anchored"><a href="#val-of_string" class="anchor"></a><code><span><span class="keyword">val</span> of_string : <span>string <span class="arrow">&#45;&gt;</span></span> <span>char <a href="Reader/index.html#type-t">Reader.t</a></span></span></code></div></div><div class="odoc-spec"><div class="spec value" id="val-of_lwt_klist" class="anchored"><a href="#val-of_lwt_klist" class="anchor"></a><code><span><span class="keyword">val</span> of_lwt_klist : <span><span><span class="type-var">'a</span> <a href="#type-lwt_klist">lwt_klist</a></span> <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'a</span> <a href="Reader/index.html#type-t">Reader.t</a></span></span></code></div></div><div class="odoc-spec"><div class="spec value" id="val-to_list_rev" class="anchored"><a href="#val-to_list_rev" class="anchor"></a><code><span><span class="keyword">val</span> to_list_rev : <span><span><span>( <span class="type-var">'a</span>, <span>[&gt; `r ]</span> )</span> <a href="#type-t">t</a></span> <span class="arrow">&#45;&gt;</span></span> <span><span><span class="type-var">'a</span> list</span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div></div><div class="odoc-spec"><div class="spec value" id="val-to_list" class="anchored"><a href="#val-to_list" class="anchor"></a><code><span><span class="keyword">val</span> to_list : <span><span><span>( <span class="type-var">'a</span>, <span>[&gt; `r ]</span> )</span> <a href="#type-t">t</a></span> <span class="arrow">&#45;&gt;</span></span> <span><span><span class="type-var">'a</span> list</span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div></div><div class="odoc-spec"><div class="spec value" id="val-to_buffer" class="anchored"><a href="#val-to_buffer" class="anchor"></a><code><span><span class="keyword">val</span> to_buffer : <span><span class="xref-unresolved">Stdlib</span>.Buffer.t <span class="arrow">&#45;&gt;</span></span> <span><span><span>( char, <span>[&gt; `r ]</span> )</span> <a href="#type-t">t</a></span> <span class="arrow">&#45;&gt;</span></span> <span>unit <span class="xref-unresolved">Lwt</span>.t</span></span></code></div></div><div class="odoc-spec"><div class="spec value" id="val-to_buffer_str" class="anchored"><a href="#val-to_buffer_str" class="anchor"></a><code><span><span class="keyword">val</span> to_buffer_str : 
  <span>?sep:string <span class="arrow">&#45;&gt;</span></span>
  <span><span class="xref-unresolved">Stdlib</span>.Buffer.t <span class="arrow">&#45;&gt;</span></span>
  <span><span><span>( string, <span>[&gt; `r ]</span> )</span> <a href="#type-t">t</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span>unit <span class="xref-unresolved">Lwt</span>.t</span></span></code></div></div><div class="odoc-spec"><div class="spec value" id="val-to_string" class="anchored"><a href="#val-to_string" class="anchor"></a><code><span><span class="keyword">val</span> to_string : <span><span><span>( char, <span>[&gt; `r ]</span> )</span> <a href="#type-t">t</a></span> <span class="arrow">&#45;&gt;</span></span> <span>string <span class="xref-unresolved">Lwt</span>.t</span></span></code></div></div><div class="odoc-spec"><div class="spec value" id="val-join_strings" class="anchored"><a href="#val-join_strings" class="anchor"></a><code><span><span class="keyword">val</span> join_strings : <span>?sep:string <span class="arrow">&#45;&gt;</span></span> <span><span><span>( string, <span>[&gt; `r ]</span> )</span> <a href="#type-t">t</a></span> <span class="arrow">&#45;&gt;</span></span> <span>string <span class="xref-unresolved">Lwt</span>.t</span></span></code></div></div><div class="odoc-spec"><div class="spec value" id="val-to_lwt_klist" class="anchored"><a href="#val-to_lwt_klist" class="anchor"></a><code><span><span class="keyword">val</span> to_lwt_klist : <span><span><span class="type-var">'a</span> <a href="Reader/index.html#type-t">Reader.t</a></span> <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'a</span> <a href="#type-lwt_klist">lwt_klist</a></span></span></code></div><div class="spec-doc"><p>Iterates on the reader. Errors are ignored (but stop the list).</p></div></div><h3 id="basic-io-wrappers"><a href="#basic-io-wrappers" class="anchor"></a>Basic IO wrappers</h3><div class="odoc-spec"><div class="spec module" id="module-IO" class="anchored"><a href="#module-IO" class="anchor"></a><code><span><span class="keyword">module</span> <a href="IO/index.html">IO</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div></div></div></body></html>